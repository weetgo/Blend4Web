b4w.register("state_machine",function(b,a){function E(l,a,c){for(var h=null,k=0;k<l.nodes.length;k++)if(l.nodes[k].id==a){h=l.nodes[k];break}return l.instances[c].current_node=h}function w(l,a){return l.instances[a].current_node}var t="DEBUG"===a("version").type();b.state_machine_create=function(){return{nodes:[],instances:[],lock:!1}};b.state_machine_add_state=function(l,a,c,h,k,b,t,w,z){l.nodes.push({id:a,allowed_ids:c,call_before_switch:h,call_after_switch:k,call_switch_from:b,call_switch_to:t,
init_state:w,payload:z,instances:[]})};b.state_machine_validate=function(l){for(var a=[],c=0;c<l.nodes;c++){var h=l.nodes[c].id;if(0<=a.indexOf(h))return t&&console.log("Found states with the same id "+h),!1;a.push(h)}for(c=0;c<l.nodes;c++)for(var h=l.nodes[c],k=0;k<h.allowed_ids.length;k++)if(0>a.indexOf(h.allowed_ids[k]))return t&&console.log("Found bad id"+h.allowed_ids[k]),!1;return!0};b.state_machine_create_instance=function(l){l.instances.push({current_node:null});for(var a=l.instances.length-
1,c=0;c<l.nodes.length;c++)l.nodes[c].instances.push({}),l.nodes[c].init_state&&l.nodes[c].init_state(l.nodes[c],l.nodes[c].instances.length-1);return a};b.state_machine_set_start_node=E;b.state_machine_get_state=w;b.state_machine_get_state_id=function(a,b){var c=a.instances[b].current_node;return c?c.id:null};b.machine_state_get_allowed_transition=function(a,b){var c=w(a,b);return c?c.allowed_ids:null};b.state_machine_switch_state=function(a,b,c){if(a.lock)return t&&console.log("state machine is locked"),
!1;var h=w(a,c),k=h.id;if(0<=h.allowed_ids.indexOf(b)){var x=!0;h.call_before_switch&&(x=h.call_before_switch(k,b,h,null,c));if(x)return x=k==b,E(a,b,c),a=w(a,c),h.call_after_switch&&h.call_after_switch(k,b,h,a,c),h.call_switch_from&&h.call_switch_from(x,!0,k,b,h,a,c),a.call_switch_to&&a.call_switch_to(x,!1,k,b,h,a,c),!0;t&&console.log("blocked by callback")}else t&&console.log("transition is not allowed: "+k+"->"+b);return!1}});b4w.register("petigor_states",function(b,a){function E(A,L,a,c){var e=F,b=M,f=T,d=U;y.get_rotation(A,f);y.get_translation(A,e);p.subtract(L,e,d);a*=g.speed;a*a<p.dot(d,d)?(c?p.normalize(d,b):(p.transformQuat(B.AXIS_MY,f,b),p.normalize(b,b)),p.scaleAndAdd(e,b,a,e)):e=L;H.append_ray_test_ext(A,[0,0,.5],[0,0,-1],"raytest_floor",function(a,L,r,d,b,c){e[2]=b[2];y.set_translation_v(A,e)},!0,!1,!0,!0);y.set_translation_v(A,e);p.subtract(L,e,d);d[2]=0;return p.dot(d,d)}function w(A,a,r){var b=N,e=T,d=W;y.get_rotation(A,
e);p.transformQuat(B.AXIS_MY,e,b);a[2]=0;p.normalize(a,a);C.rotationTo(b,a,d);C.multiply(d,e,d);a=p.dot(b,a);a=Math.acos(1<a?1:-1>a?-1:a);r=g.speed/g.dist_err*r/Math.abs(a)*Math.PI/2;r=Math.min(r,1);C.slerp(e,d,r,d);y.set_rotation_v(A,d);return a-a*r}function t(a){var d=a.payload.anim_obj,r=a.payload.anim;a=a.instances[g.ro_sm_node_state.instance_id];for(var b=0;b<r.length;b++)if(a.anim){var e=a.anim[r.name];e||(e=r[b].slot);m.play(d,null,e)}}function l(a,d){for(var r=a.payload.anim_obj,b=a.payload.anim,
e=a.instances[g.ro_sm_node_state.instance_id],c=0;c<b.length;c++)if(e.anim){var f=e.anim[b.name];f||(f=b[c].slot);d||m.set_frame(r,0,f);m.stop(r,f)}}function Q(a,b,d){var c=g.ro_sm_node_state.node;d=c.instances[g.ro_sm_node_state.instance_id];if(!d.pause){t(c);a=f.get_sensor_value(a,b,0);var e=d.path;if(e)if(c=e.length/3,d.path_point_index>=c)g.dest_rotation?(d=g.character,b=U,p.transformQuat(B.AXIS_MY,g.dest_rotation,b),a=w(d,b,a),Math.abs(a)<.001*Math.PI&&(g.accurate_translation=!1,u(1))):(g.accurate_translation=
!1,u(1));else if(e.length&&e[3*d.path_point_index]){b=new Float32Array(3);b[0]=e[3*d.path_point_index];b[1]=e[3*d.path_point_index+1];b[2]=e[3*d.path_point_index+2];var e=g.dist_err*g.dist_err,h=E(g.character,b,a,g.accurate_translation);h<e?(g.accurate_translation=!0,d.path_point_index>=c&&!g.dest_rotation?(u(1),g.accurate_translation=!1):h<e/1E3&&d.path_point_index++):(d=g.character,c=F,e=M,y.get_translation(d,c),p.subtract(b,c,e),w(d,e,a))}else g.accurate_translation=!1,u(1);else u(1)}}function c(a,
d,b,c){a.instances[d].action={speakers:null,manifold_name:b,callback:c};d=a.instances[d];d.action.speakers=[];a=a.payload.sound;for(var e in a)d.action.speakers.push(I.get_object_by_name(a[e].name))}function h(a,d){var b=a.instances[d];if(b.action){var c=b.action.speakers,b=b.action.manifold_name,e=a.payload.anim_obj,g;for(g in c)D.stop(c[g]);l(a);b&&f.check_sensor_manifold(e,b)&&f.remove_sensor_manifold(e,b)}}function k(a,d){var b=a.instances[d];if(b.action){var c=b.action.speakers,e=b.action.manifold_name,
h=b.action.callback,l=a.payload.anim_obj;if(!b.pause){var k=a.payload.anim_obj,P=a.instances[g.ro_sm_node_state.instance_id];P.anim={};for(var F=0;F<a.payload.anim.length;F++){var n=a.payload.anim[F],p=m.get_slot_num_by_anim(k,n.name);0>p&&(p=n.slot,P.anim[n.name]=p,m.apply(k,n.name,p));m.set_behavior(k,n.flags,p)}k=f.create_elapsed_sensor();e&&h&&f.create_sensor_manifold(l,e,f.CT_CONTINUOUS,[k],null,h)}for(var q in c)D.play(c[q]);t(a);b.pause=!1}}function x(a,b){c(a,b,"moving",Q)}function G(a,b,
d,c,e,f,g){if(a){if(a=e.instances[g],a.action){b=a.action.speakers;for(var k in a.speakers)D.pause(b[k]);l(e,!0);a.pause=!0}}else h(e,g)}function K(a,b,c,f,e,h,l){a=h.instances[l];y.get_translation(g.character,g.source);y.get_tsr(g.navmesh_obj,V);d.invert(V,R);d.transform_vec3(g.source,R,N);d.transform_vec3(g.destination,R,M);b={navmesh_island:H.navmesh_get_island(g.navmesh_obj,N)};(b=H.navmesh_find_path(g.navmesh_obj,N,M,b).positions)&&b.length?(a.path_point_index=1,a.path=b,g.positions=b):a.path_point_index=
0;k(h,l,!0)}function z(a,b){c(a,b,"standing")}function S(a,b,d,c,e,f,g){a||h(e,g)}function J(a,b,d,c,e,f,g){k(f,g)}function n(a,b,d,c,e){g.ro_sm_node_state={node:c,instance_id:e}}function u(a){return q.state_machine_switch_state(v,a,O)}var m=a("animation"),y=a("transform"),q=a("state_machine"),D=a("sfx"),B=a("util"),f=a("controls"),C=a("quat"),H=a("physics"),I=a("scenes"),p=a("vec3"),d=a("tsr"),P={START:0,STANDING:1,MOVING:2,MOVING_TO_TARGET:3,INTERACTING:4},F=new Float32Array(3),N=new Float32Array(3),
M=new Float32Array(3),U=new Float32Array(3),T=new Float32Array(4),W=new Float32Array(4);b.state_id_by_name=function(a){return P[a]};b.STANDING=1;b.MOVING=2;b.MOVING_TO_TARGET=3;b.INTERACTING=4;var v=null,O=null,g=null,V=d.create(),R=d.create();b.init=function(a){if(v)throw"It's a singleton!!!";g=a;v=q.state_machine_create();q.state_machine_add_state(v,0,[4],null,n);q.state_machine_add_state(v,1,[1,2,4,3],null,n,S,J,z,{anim_obj:g.character_armature,anim:[{slot:m.SLOT_0,name:"petigor_quest_idle",flags:m.AB_CYCLIC}],
sound:[]});q.state_machine_add_state(v,2,[1,2,3],null,n,G,K,x,{anim_obj:g.character_armature,anim:[{slot:m.SLOT_0,name:"petigor_quest_walk",flags:m.AB_CYCLIC}],sound:[{name:"quest_walking_circle"}]});q.state_machine_add_state(v,3,[1],null,n,G,K,x,{anim_obj:g.character_armature,anim:[{slot:m.SLOT_0,name:"petigor_quest_walk",flags:m.AB_CYCLIC}],sound:[{name:"quest_walking_circle"}]});q.state_machine_add_state(v,4,[1,4],null,n,null,null,null,{});q.state_machine_validate(v);O=q.state_machine_create_instance(v);
q.state_machine_set_start_node(v,0,O);u(4)};b.get_state=function(){return q.state_machine_get_state_id(v,O)};b.switch_state=u});if(b4w.module_check("quest"))throw"Failed to register module: quest";
b4w.register("quest",function(b,a){function E(a,b){b?(document.getElementById("preloader_cont").style.visibility="visible",x.detect_mobile()||z.set("srgb_type","SRGB_PROPER"),K.load(H+"quest/main_scene_quest.json",k,w,!0)):m_print.log("b4w init failure")}function w(a){var b=document.getElementById("prelod_dynamic_path"),c=b.nextElementSibling;b.style.width=a+"%";c.innerHTML=a+"%";100==a&&t()}function t(){var a=document.getElementById("preloader_cont");setTimeout(function(){a.style.visibility="hidden"},
1E3)}function l(a,b){I||(f.destination=new Float32Array(3),f.source=new Float32Array(3),B.get_translation(f.character,f.source),B.get_translation(a[0],f.destination),f.dest_rotation=new Float32Array(4),B.get_rotation(a[0],f.dest_rotation),n.switch_state(n.MOVING_TO_TARGET),I=!0);return n.get_state()!=n.MOVING_TO_TARGET?(I=!1,f.dest_rotation=null,n.switch_state(n.STANDING),!1):!0}function Q(a,b){var c=n.state_id_by_name(a[0]);0<=c?n.switch_state(c):console.log("Bad state, please check the name")}function c(a,
b){f.speed=a[0]}function h(a,b,c){a=m.get_sensor_payload(a,b,0);f.destination=new Float32Array(3);f.source=new Float32Array(3);D.copy(a.hit_pos,f.destination);B.get_translation(f.character,f.source);n.switch_state(n.MOVING);m.check_sensor_manifold(null,"ray_test")&&m.remove_sensor_manifold(null,"ray_test")}function k(a,b){G.enable_camera_controls();f.character=u.get_object_by_name("petigor_quest");f.character_armature=u.get_object_by_dupli_name("petigor_quest","petigor_armature_quest");f.navmesh_obj=
u.get_object_by_name("navmesh");J.append_custom_callback("switch_state",Q);J.append_custom_callback("move_to_target",l);J.append_custom_callback("set_variables",c);n.init(f);var h=m.create_mouse_click_sensor(),k=m.create_touch_click_sensor();m.create_sensor_manifold(null,"click",m.CT_SHOT,[h,k],m.default_OR_logic_fun,p)}var x=a("main"),G=a("app"),K=a("data"),z=a("config"),S=a("version"),J=a("logic_nodes"),n=a("petigor_states"),u=a("scenes"),m=a("controls"),y=a("camera"),q=a("math"),D=a("vec3"),B=
a("transform");a("tsr");a("geometry");a("material");var f={character:void 0,character_armature:void 0,navmesh:void 0,navmesh_obj:void 0,source:new Float32Array(3),click:!1,speed:1,dist_err:.2,accurate_translation:!1},C="DEBUG"==S.type(),H=z.get_std_assets_path()+"petigors_tale/",I=!1,p=function(a,b,c){c=m.get_sensor_payload(a,b,0).coords;c[0]&&c[1]||(c=m.get_sensor_payload(a,b,1).coords);b=q.create_pline();f.to||(f.to=new Float32Array(3),f.from=new Float32Array(3));a=u.get_active_camera();y.calc_ray(a,
c[0],c[1],b);q.get_pline_directional_vec(b,f.to);D.scale(f.to,1E3,f.to);D.copy([0,0,0],f.from);m.check_sensor_manifold(null,"ray_test")&&m.remove_sensor_manifold(null,"ray_test");c=[];b=["raytest_floor","ray_protect"];for(var k=0;k<b.length;k++)c.push(m.create_ray_sensor(a,f.from,f.to,b[k],!1,!0,!0));m.create_sensor_manifold(null,"ray_test",m.CT_SHOT,c,function(a){for(var b=!1,c=1;c<a.length;c++)b=b||a[c];return a[0]&&!b},h)};b.init=function(){var a=x.detect_mobile();G.init({canvas_container_id:"canvas3d",
callback:E,quality:a?z.P_LOW:z.P_HIGH,physics_enabled:!0,console_verbose:!0,alpha:!1,physics_use_workers:!a,assets_dds_available:!C,assets_pvr_available:!C,assets_min50_available:!C,show_fps:C,autoresize:!0})}});b4w.require("quest").init("en");
